name: Unified FinTech Intelligence System

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  run-intelligence:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify config file exists
      run: |
        if [ -f unified_config.json ]; then
          echo "Config file found"
          python -c "import json; json.load(open('unified_config.json'))"
        else
          echo "ERROR: unified_config.json not found"
          exit 1
        fi
        
    - name: Download previous database
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: unified-fintech-database
        path: .
        
    - name: Check for existing database
      run: |
        if [ -f unified_fintech_intelligence.db ]; then
          echo "Previous database found"
          du -h unified_fintech_intelligence.db
        else
          echo "No previous database found - will create new one"
        fi
        
    - name: Run Unified FinTech Intelligence
      run: |
        echo "Starting Unified FinTech Intelligence at $(date)"
        python Unified_FinTech_Intelligence.py --verbose
        echo "Intelligence system completed at $(date)"
      env:
        COMPANIES_ENABLED: ${{ vars.COMPANIES_ENABLED || '1' }}
        TRENDS_ENABLED: ${{ vars.TRENDS_ENABLED || '1' }}
        LLM_INTEGRATION_ENABLED: ${{ vars.LLM_INTEGRATION_ENABLED || '1' }}
        SEMANTIC_SCORING_ENABLED: ${{ vars.SEMANTIC_SCORING_ENABLED || '1' }}
        KEYWORD_EXPANSION_ENABLED: ${{ vars.KEYWORD_EXPANSION_ENABLED || '1' }}
        STRICT_REGION_FILTER: ${{ vars.STRICT_REGION_FILTER || '1' }}
        GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
        GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        SMTP_HOST: ${{ secrets.SMTP_HOST || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        LLM_MODEL: ${{ vars.LLM_MODEL || 'gpt-4o-mini' }}
        LLM_TEMPERATURE: ${{ vars.LLM_TEMPERATURE || '0.1' }}
        LLM_MAX_RETRIES: ${{ vars.LLM_MAX_RETRIES || '3' }}
        LLM_MAX_TITLE_ENHANCEMENTS: ${{ vars.LLM_MAX_TITLE_ENHANCEMENTS || '25' }}
        LLM_MAX_SUMMARIES: ${{ vars.LLM_MAX_SUMMARIES || '15' }}
        LLM_MAX_TOKENS_TITLE: ${{ vars.LLM_MAX_TOKENS_TITLE || '32' }}
        LLM_MAX_TOKENS_SUMMARY: ${{ vars.LLM_MAX_TOKENS_SUMMARY || '120' }}
        LLM_SUMMARY_FALLBACK_ENABLED: ${{ vars.LLM_SUMMARY_FALLBACK_ENABLED || '1' }}
        RELEVANCE_THRESHOLD: ${{ vars.RELEVANCE_THRESHOLD || '0.58' }}
        MAX_EMAIL_ARTICLES: ${{ vars.MAX_EMAIL_ARTICLES || '40' }}
        SEMANTIC_TOTAL_LIMIT: ${{ vars.SEMANTIC_TOTAL_LIMIT || '60' }}
        GOOGLE_SEARCH_DAILY_LIMIT: ${{ vars.GOOGLE_SEARCH_DAILY_LIMIT || '100' }}
        COMPANY_HOURS_WINDOW: ${{ vars.COMPANY_HOURS_WINDOW || '72' }}
        COMPANY_MAX_AGE_DAYS: ${{ vars.COMPANY_MAX_AGE_DAYS || '3' }}
        COMPANY_MAX_ITEMS_PER_SOURCE: ${{ vars.COMPANY_MAX_ITEMS_PER_SOURCE || '50' }}
        DATABASE_PATH: unified_fintech_intelligence.db
        TREND_CONFIG_JSON: unified_config.json
        KEEP_HISTORICAL_DAYS: ${{ vars.KEEP_HISTORICAL_DAYS || '30' }}
        USE_CONNECTION_POOL: ${{ vars.USE_CONNECTION_POOL || '1' }}
        LOG_LEVEL: ${{ vars.LOG_LEVEL || 'INFO' }}
        TZ: America/New_York
        
    - name: Analyze system outputs
      run: |
        echo "=== Database Analysis ==="
        if [ -f unified_fintech_intelligence.db ]; then
          echo "Database file exists"
          du -h unified_fintech_intelligence.db
          if command -v sqlite3 >/dev/null 2>&1; then
            sqlite3 unified_fintech_intelligence.db 'SELECT COUNT(*) FROM articles;' 2>/dev/null || echo 'Unable to count'
          fi
        else
          echo "WARNING: Database file not found"
        fi
        
        echo "=== Log Analysis ==="
        if [ -f unified_fintech_intelligence.log ]; then
          echo "Log file exists"
          du -h unified_fintech_intelligence.log
          grep -c ERROR unified_fintech_intelligence.log || echo 0
        else
          echo "WARNING: Log file not found"
        fi
        
    - name: Upload database artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unified-fintech-database
        path: unified_fintech_intelligence.db
        retention-days: 30
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: intelligence-logs-${{ github.run_number }}
        path: unified_fintech_intelligence.log
        retention-days: 7
        
    - name: Upload config snapshot
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: config-snapshot-${{ github.run_number }}
        path: unified_config.json
        retention-days: 7
        
    - name: Execution summary
      if: always()
      run: |
        echo "=== EXECUTION SUMMARY ==="
        echo "Job status: ${{ job.status }}"
        echo "Run number: ${{ github.run_number }}"
        echo "Time: $(date)"
